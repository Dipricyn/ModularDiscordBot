<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: plugin.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: plugin.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const mkdirp = require('mkdirp');
const path = require('path');
const botutil = require('./botutil.js');
const CommandContainer = require('./commandcontainer.js')

/**
 * The base class to be extended by all bot plugins.
 * It provides methods to facilitate the implementation of a plugin.
 */
class Plugin {

    /**
     * The identifier is used to identify plugin and to 
     * provide a location to store permanent data.
     * @param {String} identifier the plugins unique identifier
     */
    constructor(identifier) {
        if(!identifier) throw Error("plugin identifier cannot be empty!")
        this._handleCommandImpl = this._handleCommandImpl.bind(this)
        /**
         * The plugin's unique identifier.
         * @type {String}
         */
        this.identifier = identifier
        /**
         * True if the plugin is running.
         * @readonly
         * @type {Boolean}
         */
        this.running = false
        /**
         * A map that stores the commands for this plugin.
         * @type {CommandContainer}
         */
        this.commandContainer = new CommandContainer()
    }

    /**
     * Called when the plugin should be started.
     * The client property is available when this method is called.
     */
    startPlugin() {}

    /**
     * Called when the plugin should be stopped.
     * The plugin must release the client instance.
     */
    stopPlugin() {}

    /**
     * Get the configuration file path for this plugin.
     * @returns {String} a relative path to the configuration file
     */
    configFileLocation() {
        const configLocation = `./config/${this.identifier}_config.json`
        mkdirp.sync(path.dirname(configLocation))
        return configLocation
    }

    /**
     * Get the data directory for this plugin.
     * @returns {String} a relative path without a trailing slash
     */
    dataDirLocation() {
        const dataLocation = `./data/${this.identifier}`
        return dataLocation
    }

    /**
     * Called to specify the default configuration parameters.
     * The config object will not be loaded from the file if the default config returns null.
     * @returns {Object} a object containing the default configuration parameters or 
     * null if a config file is not needed
     */
    defaultConfig() {
        return null
    }

    _handleCommandImpl(message) {
        if(message.content.substring(0, 1) !== '!') {
            return
        }
        const args = message.content.substring(1).split(' ')
        const cmd = args.splice(0, 1)[0]
        const command = this.commandContainer.get(cmd)
        if(!command) return
        if(!command.options.handleBotMsgs) {
            if(message.author.bot) return
        }
        if(command.options.requireChannelType) {
            switch(command.options.requireChannelType){
                case "direct":
                    if(["dm", "group"].indexOf(message.channel.type)===-1) {
                        message.channel.send("You must send this command in a direct message!")
                        return
                    }
                    break;
                case "guild":
                    if(["text", "voice", "category"].indexOf(message.channel.type)===-1) {
                        message.channel.send("You must send this command in a channel!")
                        return
                    }
                    break;
                default:
                    throw Error(`unknown required channel type: ${command.options.requireChannelType}!`)
            }
        }
        const guild = this.client.guilds.first()
        if(command.options.elevated) {
            if(!guild.member(message.author).hasPermission("ADMINISTRATOR")) {
                message.channel.send("Insufficient permissions! You need to be an administrator to do that.")
                return
            }
        }
        command.handler(args, message)
    }

    _startPluginImpl(client) {
        this.client = client
        mkdirp.sync(this.dataDirLocation())
        const config = this.defaultConfig()
        if(config) {
            botutil.writeJSONObjectSyncIfNotExists(this.configFileLocation(), config)
            this.config = botutil.loadJSONSyncIfExists(this.configFileLocation())
        }
        this.running = true
        this.client.on('message', this._handleCommandImpl)
        this.startPlugin()
    }

    _stopPluginImpl(client) {
        this.stopPlugin()
        this.client.removeListener('message', this._handleCommandImpl)
        this.client = null
        this.running = false
    }
}
module.exports = Plugin</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Command.html">Command</a></li><li><a href="CommandHidingPlugin.html">CommandHidingPlugin</a></li><li><a href="NoticeMePlugin.html">NoticeMePlugin</a></li><li><a href="Plugin.html">Plugin</a></li><li><a href="PluginContainer.html">PluginContainer</a></li><li><a href="PluginManagementPlugin.html">PluginManagementPlugin</a></li><li><a href="SoundboardPlugin.html">SoundboardPlugin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#loadJSONSyncIfExists">loadJSONSyncIfExists</a></li><li><a href="global.html#writeJSONObjectSyncIfNotExists">writeJSONObjectSyncIfNotExists</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
